---
title: "**NeoNet app**, mapping radiocarbon dating online"
author: "Thomas Huet, Niccolo Mazzucco"
# date: "11/12/2020"
header-includes:
  - \usepackage{float}
  - \floatplacement{figure}{H}  #make every figure with capti
output: html_document
---

```{r setup, include=FALSE}
# knitr::opts_chunk$set(echo = FALSE, fig.width = 19, fig.height = 14)
knitr::opts_chunk$set(echo = FALSE, fig.width = 19, fig.height = 14, fig.align = TRUE)
library(kableExtra)
library(dplyr)
library(knitr)
library(magick)
GHimgs <- "https://github.com/zoometh/C14/tree/main/docs/imgs/"
## sizes
# map
panel.map <- image_read("../docs/imgs/panels_map.png")
panel.map.coords <- image_read("../docs/imgs/panel_map_coords.png")
ratio.panel.map.coords <- image_info(panel.map.coords)$height/image_info(panel.map.coords)$width
# panel.map <- image_read("https://raw.githubusercontent.com/zoometh/C14/main/docs/imgs/panels_map.png")
ratio.panel.map <- image_info(panel.map)$height/image_info(panel.map)$width
# calib
panel.calib <- image_read("../docs/imgs/panels_calib.png")
# panel.calib <- image_read("https://raw.githubusercontent.com/zoometh/C14/main/docs/imgs/panels_calib.png")
ratio.panel.calib <- image_info(panel.calib)$height/image_info(panel.calib)$width
```

The **NeoNet app** allows the selection of radiocarbon dating by location, chronology and material life duration by subsetting a radiocarbon dataset according to: 

* a geographical region of interest (ROI)
* a time span between a *tpq* and a *taq* in cal BC
* some periods
* some type of material life duration (short like, long life or others)
* a maximum accepted standard deviation threshold (SD)

We will see how to use the [**NeoNet app**](#app), the [**NeoNet database**](#bd) and how to [**participate**](#particip)

## How to use the **NeoNet app** {#app}

The **NeoNet app** is a [RShiny](https://shiny.rstudio.com/) interactive web application. 

<p style="text-align: center;"> <font size="5"> the **[NeoNet app](https://neolithic.shinyapps.io/NeoNet/)** </font>
[![](https://raw.githubusercontent.com/zoometh/C14/main/docs/imgs/app_neonet.png){width=50%}](https://neolithic.shinyapps.io/NeoNet/)
</p>  

The app is divided into 4 panels:

* [**map** panel](#panel.map): geographical region of interest with different possibilities to subset the datings dataset
* [**calib** panel](#panel.calib): calibration on-the-fly of the selected datings
* **data** panel: the whole dataset with search tools
* **infos** panel: data and IT source, gathering, credits and link to the **NeoNet app** webpage

The two main panels are **map** and **calib**


### **map** panel {#panel.map}
![](https://raw.githubusercontent.com/zoometh/C14/main/docs/imgs/panel_map_idx.png){width=20%}


The panel **map** is used for selection of radiocarbon dating by location, chronology and material life duration.

* The top-left button **group c14 on map** (<span style="color:red">red</span> box) allows to cluster datings by spatial proximities (see [Marker Clusters](http://rstudio.github.io/leaflet/markers.html))
* The top-right checkboxes  **periods** (<span style="color:brown">brown</span> box) allows to select dataions by periods. An hyperlink allows to understand the [abrevations of the periods](https://htmlpreview.github.io/?https://github.com/zoometh/C14/blob/main/period_abrev.html)

```{r panel.map,echo=FALSE,message=FALSE,fig.fullwidth=TRUE,fig.asp=ratio.panel.map}
# par(mar = c(0, 0, 0, 0))
# # A tibble: 1 x 7
#   format width height colorspace matte filesize density
#   <chr>  <int>  <int> <chr>      <lgl>    <int> <chr>  
# 1 PNG     1664    886 sRGB       TRUE   1496175 118x118
map.group.c14 <- image_draw(panel.map)
# xleft, ybottom, xright, ytop
# Group button
rect(20, 30, 200, 160,
     border = "red", lty = "dashed", lwd = 4)
# dynamic periods
rect(20, 750, 130, 600,
     border = "orange", lty = "dashed", lwd = 4)
# slider
rect(150, 720, 800, 650,
     border = "blue", lty = "dashed", lwd = 4)
# dynamic table
rect(20, 886, 1650, 770,
     border = "green", lty = "dashed", lwd = 4)
# SDs
rect(1300, 720, 1650, 600,
     border = "purple", lty = "dashed", lwd = 4)
# button periods
rect(1450, 30, 1650, 550,
     border = "brown", lty = "dashed", lwd = 4)
invisible(dev.off())
plot(map.group.c14)
```

* The bottom-left legend **periods** (<span style="color:orange"><b>orange</b></span> box) is a dynamic list of periods which exist in the selection (see checkboxes  **periods**)
* The bottom-left slider  **tpq-taq** (<span style="color:blue"><b>blue</b></span> box) allows to subset a range of dating between a tpq and a taq (in cal BC) 
* The bottom-right checkboxes and slider  **material life duration and max accepted SD** (<span style="color:purple"><b>purple</b></span> box) allow to subset a range of dating:
  + relatively to the duration of their material (short to long-life material). An hyperlink allows to understand the [classification of the material into the short life, long life and others](https://htmlpreview.github.io/?https://github.com/zoometh/C14/blob/main/material_life.html) categories
  + below a maximum accepted threshold for the standard deviations (SD) for the datings
* The table at the bottom (<span style="color:green"><b>green</b></span> box) is a dynamic table which list all the datings within the map and in the selection (tpq/taq, material life duration, maximum SD, periods). A count of selected sites and selected datings is dynamically done above this table.  

#### retrieve coordinates of an archaeological site {#map.coords}

The default geographical background of the app, the [OpenStreetMap map](https://www.openstreetmap.org/#map=6/37.753/14.524) (OSM), offers a well documented basemap. In OSM, archaeological sites are sometimes already mapped, like the Ligurian sites of [Arene Candide](https://www.openstreetmap.org/#map=19/44.16233/8.32827) and [Grotta della Pollera](https://www.openstreetmap.org/#map=19/44.20058/8.31466). 

Clicking on the NeoNet app map show the lat/long coordinates of the current point (<span style="color:red"><b>red</b></span> box under the tpq/tap slider). These coordinates can then be copied and used to modify the NeoNet database. 

```{r panel.map.coords.img,echo=FALSE,message=FALSE,fig.width=5, fig.height=5}
# par(mar = c(0, 0, 0, 0))
# # A tibble: 1 x 7
#   format width height colorspace matte filesize density
#   <chr>  <int>  <int> <chr>      <lgl>    <int> <chr>  
# 1 PNG     1664    886 sRGB       TRUE   1496175 118x118
panel.map.coords.img <- image_draw(panel.map.coords)
# xleft, ybottom, xright, ytop
# Group button
rect(120, 270, 270, 300,
     border = "red", lty = "dashed", lwd = 4)
invisible(dev.off())
plot(panel.map.coords.img)
```

OSM search bar permits to find these two Ligurian sites and many others... 

<!-- <p style="text-align: center;"> -->
<!-- ![](https://raw.githubusercontent.com/zoometh/C14/main/docs/imgs/panel_map_coords.png){width=40%} -->
<!-- </p>  -->

### **calib** panel {#panel.calib}
![](https://raw.githubusercontent.com/zoometh/C14/main/docs/imgs/panel_calib_idx.png){width=20%}
  
  
The panel **calib** is used for dating calibration on-the-fly with the R packages Bchron and radiocarbon. Calibrations are done on the whole dataset of datings displayed in the **map** panel.

* The top-center radio button **c14 group by common site, layer/structure and/or period** (<span style="color:red"><b>red</b></span> box) allows to plot datings:
  - by dating: each dating is plot separeltly (by default)
  - by site and layer: datings coming from the same site and having the same layer/structure are cumulated
  - by site and period: datings coming from the same site and having the same period are cumulated
  - by period: datings having the same period are cumulated
  - all C14: all datings are cumulated together  
  
```{r panel.calib, echo=FALSE, message=FALSE, fig.fullwidth=TRUE, fig.asp=ratio.panel.calib}
# # A tibble: 1 x 7
#   format width height colorspace matte filesize density
#   <chr>  <int>  <int> <chr>      <lgl>    <int> <chr>  
# 1 PNG     1664    886 sRGB       TRUE   1496175 118x118

calib.group.c14 <- image_draw(panel.calib)
# > image_info(panel.map)
# # A tibble: 1 x 7
#   format width height colorspace matte filesize density
#   <chr>  <int>  <int> <chr>      <lgl>    <int> <chr>  
# 1 PNG     1518    702 sRGB       TRUE     63969 118x118
# # xleft, ybottom, xright, ytop
# Group button
rect(1400, 0, 1500, 70,
     border = "green", lty = "dashed", lwd = 4)
# download
rect(700, 0, 1300, 70,
     border = "red", lty = "dashed", lwd = 4)
# dynamic periods
rect(20, 80, 1400, 700,
     border = "orange", lty = "dashed", lwd = 4)
# # slider
# rect(150, 720, 800, 650,
#      border = "blue", lty = "dashed", lwd = 4)
# # dynamic table
# rect(20, 886, 1650, 770,
#      border = "green", lty = "dashed", lwd = 4)
# # SDs
# rect(1300, 720, 1650, 600,
#      border = "purple", lty = "dashed", lwd = 4)
# # button periods
# rect(1450, 30, 1650, 550,
#      border = "brown", lty = "dashed", lwd = 4)
invisible(dev.off())
plot(calib.group.c14)
```

* The graph area (<span style="color:orange"><b>orange</b></span> box) shows dynamically the SPD of the cabibrated datings seriated on their weighted means. The top-right  button **Download** (<span style="color:green"><b>green</b></span> box) allows to export the last plot in a PNG image

<p style="text-align: center;">
![](https://raw.githubusercontent.com/zoometh/C14/main/docs/imgs/neonet_calib_example.png){width=80%}
</p>


## How to use the **NeoNet database** {#bd}

The **NeoNet database** is a collaborative online Google Sheet. The database is composed by 3 spreadsheets: [**c14**](#bd.C14), [**material.life**](#bd.material) and [**period.abrev**](#bd.period) 

### **c14** {#bd.C14}
![](https://raw.githubusercontent.com/zoometh/C14/main/docs/imgs/app_neonet_db_c14.png){width=30%}  

This is the complete database. The **mandatory fields** are:

* **SiteName**: the site name
* **Longitude**: in decimal degrees (ex: 1.04573)
* **Latitude**: in decimal degrees (ex: 43.9265)
* **Period**: a value from the [**period.abrev**](#bd.period) spreadsheet
* **C14Age**: a numerical radiocarbon dating in BP
* **C14SD**: the standard deviation of the radiocarbon dating
* [**LabCode**](#mf.labcode): the unique identifier of the radiocarbon dating
* **Material**: a value from the [**material.life**](#bd.material) spreadsheet 
* **tpq**: the *terminus post quem* of the radiocarbon dating in cal BC
* **taq**: the *terminus ante quem* of the radiocarbon dating in cal BC

The **recommended** fields are:

* **PhaseCode**: a code for the dating stratigaphical unit and/or structure
* **bib**: a plain text bibliographical reference
* **bib_url**: the current URL of the reference or its notice 
* **MaterialSpecies**: a specification of the field **Material**
* **Culture**: a specification of the field **Period**

The others fields only concern the **[EUROEVOL_R app](https://zoometh.github.io/C14)** 

#### **mandatory fields**

All these fields are needed to make app working

##### **LabCode** {#mf.labcode}

The correct syntax for a laboratory code (**LabCode**) is '*AbrevLab*-*number*'. For example:

```{r LabCode, echo=FALSE}
# knitr::include_url("../docs/material_life.html", height = "400px")
# knitr::include_url("https://raw.githubusercontent.com/zoometh/C14/main/docs/material_life.html", height = "200px")
# htmltools::includeHTML()
ex.labcode <- c("Beta-103487", "CSIC-1133", "ETH-15984", "Gif-1855", "KIA-21356",
                "LTL-13440A", "Ly-11338", "MC-2145", "OxA-9217","Poz-18393","...")
df.ex.labcode <- data.frame(LabCode = ex.labcode,
                         stringsAsFactors = F)
kable(df.ex.labcode,"html") %>%
  kable_styling(full_width = FALSE, position = "center", font_size=12)
```


### **material.life** {#bd.material}
![](https://raw.githubusercontent.com/zoometh/C14/main/docs/imgs/app_neonet_db_material.png){width=30%}

The two fields show the material type and the material life duration, for example: 

```{r material.life, echo=FALSE}
# knitr::include_url("../docs/material_life.html", height = "400px")
# knitr::include_url("https://raw.githubusercontent.com/zoometh/C14/main/docs/material_life.html", height = "200px")
# htmltools::includeHTML()
df.mat.life <- data.frame(material.type = c("bone","seed","wood","..."),
                         life.duration = c("short life", "short life", "long life","..."),
                         stringsAsFactors = F)
kable(df.mat.life,"html") %>%
  kable_styling(full_width = FALSE, position = "center", font_size=12)
```

You can also [see the entire dataframe ](https://htmlpreview.github.io/?https://github.com/zoometh/C14/blob/main/docs/material_life.html)

### **period.abrev** {#bd.period}
![](https://raw.githubusercontent.com/zoometh/C14/main/docs/imgs/app_neonet_db_period.png){width=30%}

The two fields show the period abreviation and the period full label, for example:

```{r period.abrev, echo=FALSE}
# knitr::include_url("../docs/material_life.html", height = "400px")
# knitr::include_url("https://raw.githubusercontent.com/zoometh/C14/main/docs/material_life.html", height = "200px")
# htmltools::includeHTML()
df.period.abrev <- data.frame(period.abrev = c("LM","LMEN","EN","..."),
                         period = c("Late Mesolithic", "Late Mesolithic/Early Neolithic", "Early Neolithic","..."),
                         stringsAsFactors = F)
kable(df.period.abrev,"html") %>%
  kable_styling(full_width = FALSE, position = "center", font_size=12)
```

You can also [see the entire dataframe ](https://htmlpreview.github.io/?https://github.com/zoometh/C14/blob/main/docs/period_abrev.html)

## How to participate {#particip}

Thanks to the facilities offer by the app, and in the frame of the **[NeoNet project](https://redneonet.com)**, conducted by [Juan Gibaja](https://orcid.org/0000-0002-0830-3570) and [Miriam Cubas](https://orcid.org/0000-0002-2386-8473), we expect to conduct collaborative spatio-temporal analysis for the origin, the spread and the consolidation of the farming way-of-life in Mediterranean.

To get an access to the permission to edit data, please contact the authors (<thomashuet7@gmail.com >, <nicco.mazzucco@gmail.com >)

### Next developments

In a context of collaborative research and Open Science, for the benefit of the scientific community, good practices and new IT developments are already planned

#### Data integration

As data came from various publications:

* an homogenisation the different values must be done
* every radiocarbon dating should be carefully referenced
* license and auhorship should be clearly defined

#### Server and database {#next.server}

Today the **NeoNet app** is host on the **[shinyapps.io](https://www.shinyapps.io/)** server, an opensource but limited solution. For example, no direct connection can be done between the app and the database (ie the Google Sheet), so the app have to be *pushed* regularly on the **shinyapps.io** server after the database have been updated (contact <thomashuet7@gmail.com > for this update)

We plan to host the app on a R server in a research institution (University, Laboratory) and to developp a **real database** on [PostgresSQL/PostGIS](https://www.postgresql.org/)

#### Open Science recommendations {#next.openscience}

In accordance with the Open Science, we will try to respect the data [**FAIR** principles](https://www.go-fair.org/fair-principles/) (*Findable*, *Accessible*, *Interoperable* & *Reusable*)

### Final objectives

At the middle term we want to:

* publish the archaeological result(s) in scientific paper(s)
* publish the **NeoNet app** development in a digital humanities papers
* present the results and the app in conferences, seminar, etc.
* present the app in dedicated workshops
* publish as FAIR open-source data the **NeoNet app** source code and the radiocarbon dataset 


